CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 1 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (313217,314665)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (313217,314665)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 2 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4275564,2874559,4173712,2002245)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4275564,2874559,4173712,2002245)
  and c.invalid_reason is null

) I
LEFT JOIN
(
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (43018731,43019585,43018671,43020075,43020074,43019484,43019483,43019485,43018730,43018395,43018566,43020070,43018668,43018875,43018876,43019760,43018669,43020071,2822632,2835848,2848302,2848303,2807547,2887780,43019988,43019764,43019765,43019069,43019884,43019488,43019883,43019586,2887781,2799784,2874573,2827859,2892843,2807549,43019177,2848299,2848300,2807546,2848301,2866382,2822631,43018565,2840424,2852842,2848297,2866380,2874571,2848298,43019882,2874577,2807552,2807553,2866389,2848304,2887784,2866384,2827860,2874575,2815237,2794168,2861505,2879802,2835849,2866386,2866385,2822636,2848306,2827862,2861509,2807551,2799786,2827861,2861506,2866383,2892844,2852844,2887783,2807554,2835852,2799788,2892845,2874576,2794169,2866387,2815240,2840428,2799910,2794171,2835854,2848312,2866394,2848313,2794327,2874581,2861516,2822641,2879937,2822640,2799911,2874580,2848311,2874579,2822637,2848307,2887787,2815242,2861519,2835857,2835856,2861517,2879939,2861518,2852850,2852851,2822643,2794328,2807560,43019071,43019180,43018882,43019588,2827864,2852852,2827865,2822644,2866391,2822638,2840426,2861512,2866392,2852846,2879808,2799909,2861513,2840427,2861514,2887788,2852847,2848310,2852848,2879934,42894769,42894768,40756812,44809812,45890318,40756792,4259143,4078442,4179713,2725382,2725383,2725378,2725380,2725379,2725381,2724750,2724751,2724746,2724748,2724747,2724749,2725320,2725321,2725316,2725318,2725317,2725319,2725258,2725259,2725254,2725256,2725255,2725257,2725095,2725093,2725094,2725053,2725051,2725052,2725199,2725866,2725863,2725869,2725747,2725746,2725816,2725815,2725810,2725809,2725822,2725821,2725637,2725670,2725667,2725673,40481952,2313916,2313915,44816449,4020231,40483085,4020092,44511471,44789913,44790436,4303988,43531516,4180615,44806571,44790480,4179979,4020091,4017884,44793474,43528002,43528004,43528003,43528001,43528000,4020525,40482273,4285725,2726519,2726534,2727186,2727264,1389578,1389711,42639428,2879798,2848174,2794165,2807542,2861501,2799781,43020068,42639194,1536538,2866378,2861500,2874570,2887775,2799780,2892838,43019449,1532893,2835846,2852839,2835847,2879795,2848170,2848169,2874568,2794164,2799779,43018982,2887773,2807541,2799777,2861497,2815230,2874563,2807538,2840416,2848163,2887769,2827849,43018392,2887768,2840415,2807539,2827853,2887772,2815232,2822627,2794162,2866376,2861499,2815233,43018666,2840421,2799778,2827852,2887771,2866375,2848165,2840419,2840418,2840420,2848166,2879793,43019881,2887770,2840417,43018567,43019987,43018397,2866531,2887802,2848334,2794337,2848333,2799929,2879960,2848326,2827991,2799918,2799917,2852980,2807565,2892972,2822787,1534820,1536188,1535946,1534129,1535200,1535255,1535812,1536499,2887798,2827992,2835993,2887799,2866522,2822789,2879953,2852981,2799932,2794338,2861665,2861664,2827999,2879961,2861663,2887803,2828000,2852984,2815255,2861667,2799935,2822796,2852989,2848337,2852986,2815374,2892976,2799933,2852987,2861668,2861669,2836003,2807703,2887934,2874724,2807704,2815376,2892978,2848336,2799934,2822794,2794341,2828003,2879964,2887804,2828001,2836001,2887805,2815377,2848464,2836008,2874726,2866533,2836006,2822795,2836005,2887937,2874728,2879966,2815382,2892982,2887940,2861675,2794349,2866537,2828009,2887939,2879967,2852993,2807709,2822801,2874729,2799936,2861671,2799938,2799937,2840570,2887945,2866538,2852994,2887942,2848469,2840569,2879968,2852995,2836010,2822803,2866539,43019337,43019894,43018686,43018404,2807711,2848470,2815383,2866540,2848466,2807706,2848467,2794345,2861674,2866536,2874727,2815380,2840567,2840568,2836009,2794346,2822799,2828007,2815381,2852991,2853001,2861680,2874733,2866545,2848474,2840575,2828013,2866542,2836014,2794354,2794355,2866543,2815389,2880103,2822805,2807714,2799948,2794356,2866544,2828015,2880104,2799946,1523326,1523772,1523672,1523607,1523445,1523545,1523751,1523904,1523488,1523686,1523764,1523847,1523353,1523333,1523609,2874742,2861691,2794368,2887959,2880114,2840583,2800074,2828025,2866557,43019076,2836022,2866556,2866555,1532475,2892995,43019338,2866554,2794367,2794366,1533307,2874746,2794521,2840589,1532081,2822822,2822821,1535215,2815400,2815405,2822827,2822826,2853019,2848488,2861827,2836029,2887963,2800081,2828160,1532685,2848487,2800080,1534470,2836160,2822959,2861831,2880127,2848491,2866691,1532056,2874754,2887966,2836161,2853146,1536337,2836031,2874753,2887965,2853145,2861828,2836033,1536173,2794522,2822958,2836032,2828163,1533395,2880125,2815406,2853021,2880126,2848490,2807727,1533279,2840592,2887964,2853020,2807726,1533741,2822961,2866694,2794524,2853149,2794523,2836163,1532312,2840594,2880128,2828165,2887968,1533052,2815407,2866693,2822960,2874755,2807730,2853147,1532241,2861833,2840593,2828164,2848492,1535914,2848494,2840595,2807733,2828166,2794526,2848496,1532826,2893009,2887969,2848495,2794525,1534622,43018410,43019593,43018894,43018895,43018747,43019496,43019078,43019341,43019340,43019495,2893140,2828167,2828168,2815410,2880130,2822962,1533963,2853152,2848497,2866697,2815409,1533841,36803410,2828156,2822824,2815403,2848485,2815404,2893151,2880141,2874892,2836172,2880140,2866707,2840723,2840722,2807875,2822974,2866711,2853169,2861853,2874897,2828179,2853170,2794537,2888106,2848640,2800097,2836175,2866712,2880280,2861851,2807872,2866708,2836173,2888103,2848641,2822976,2866714,2893153,2807878,2880282,2836176,2853171,2822977,2848643,2880283,2848642,43018577,43019775,43020087,43018578,2836178,2800099,2840728,2893154,2866709,2822972,2853166,2874894,2866710,2861848,2893152,2828174,2880142,2794535,2874896,2836174,2828175,2880277,2853168,2848639,2893157,2812942,2861857,2828183,2853176,2794541,2866847,2840733,2800104,1536274,2874902,2812943,2828182,2848648,2822982,2836183,2866722,1532747,2861856,2866721,2893156,2853175,2800101,2822979,2822980,2836180,2880285,2874900,2840729,43019597,2836179,2848645,2794539,1535760,2866719,2807881,2800103,2822978,2880284,2888108,43019465,2807880,2828181,2866718,1532449,2800102,2866717,2866716,36803242,36802966,2794551,2836188,2822992,2893162,2822985,2880290,2880291,2812949,2888116,2861862,2848655,2853183,2794547,2861861,2836184,2888115,2828187,2848656,2800107,2800106,2888117,2866849,2822987,2794548,2840734,2853179,2853180,2861859,2848650,2848652,2888110,2848651,2880288,2866848,2893160,2880289,2828185,2861858,2888111,2893158,2840735,2848653,2874903,36802938,36803387,36803284,36802999,36803204,36803073,1536392,1533689,2813132,2862175,2841053,2848959,2853508,1535377,1535699,1533333,2893344,2823316,2794916,2875088,2848961,2853511,2836499,2848962,2823324,2893352,2875090,1532612,2848963,2823323,2875089,2813269,2800754,2867028,2794917,1533822,2862181,2867029,2794908,2880477,2800747,2841052,2823318,2853505,2794910,2867025,2848838,43019900,2875085,2823317,2880479,1532027,2800748,2828506,2853504,2867024,2893345,2813131,43018418,2880478,2867023,2853503,1533324,2862174,2808076,2794909,1532097,1532121,2880482,2794911,2841054,2828509,2880483,1532122,1534326,1534284,1536093,1533826,2794912,2794913,2813134,2893350,2813133,1534964,1533016,1536082,36803026,36803369,1533839,1534684,2794914,2836496,2813267,2880485,2823322,1534915,1536550,1535529,2853510,2862178,2848818,2813114,2794736,2875059,2888273,2808050,2840900,2880457,2862023,2808049,2836334,2862016,2813106,2874929,2813108,2853341,2813107,2874928,2813105,2880448,2880450,2848812,2813112,2840897,2813113,2893327,2808045,2848813,2880451,2840896,2893324,2836335,2848810,2862018,2853342,2794733,2848811,2808044,2866875,2874930,2848814,2800261,2823156,2866878,2888270,2862019,2840898,2794734,2828349,2874931,1523620,1523608,1523601,1523448,1523864,1523563,1523835,2880469,2853496,2813126,2836360,2808065,2823170,2853350,2808052,2848820,2813119,2888278,2800268,2893332,2888277,2893331,2888276,2836350,2853351,2862030,2862031,2828357,2853352,2836352,2836351,2808054,2800270,2848821,2840903,2794738,2836348,2840904,2828356,2848823,2848822,2808053,2888279,2828358,2828359,2828360,2836353,2823162,2866883,2823161,2800272,2808055,2823160,43014802,43014822,43014812,42537597,43531439,44806668,2001504,37157744,4337739,4337738,4336469,43531438,4337740,37206820,43531515,4080289,4264286,4337741,43533352,43533247,4178169,45769228,40487945,4177366,44790409,4322906,44511138,44784573,43533248,43533353,2313795,4018703,37153597,37157437,43531440,4229994,2001523,2001501,2001500,2617370,2617369,1389580,44806005,40756772,40756774,2001549,4051039,2727297,4137127,2720628,2617584,40756784,40756789,4208483,4323638,44511139,44511223,44511051,44511275,44511457,44789848,40484106,4338620,4338183,4339980,4336606,4339716,4337196,4336902,4339967,4174690,4195096,4337289,4017882,44511466,4010256,4271860,4306306,4043696,2001435,4171677,4020382,4337198,4287403,4120152,4336743,4054814,44511026,44511468,4146733,4186747,2001473,2107178,2107027,1552633,1389579,1389577,4089017,4276350,4339949,4337308,44805463,36684977,4201063,2726162,43019073,43019459,43019893,43018571,2887795,43018741,43018889,2852859,2835863,2848321,43020083,43018740,43019187,43018402,2835864,43019886,43019458,2815247,2822647,2852853,2852854,2879941,43019182,43018401,43018734,43020080,2807562,43019995,43019183,2887792,2815243,2807561,43020079,43018884,43019181,43019994,2799912,43018400,43019454,2815244,2848320,2827988,2879946,2861654,43019891,43020082,43019491,43018987,2887794,43019770,43019456,2827989,2852856,2835862,43019769,43018986,43019590,43018683,2852857,43019335,43018682,2874583,2799914,2861521,2822650,2835861,43018737,43018569,43019185,43018888,2822651,43019589,43018887,2879944,2815245,2822649,43018886,43019767,43019184,43020081,2827866,43019455,43019885,2827986,2879951,2879952,2815249,2887796,2892970,2892969,2840433,2815248,2815253,2874594,2861658,2827996,2835995,2840560,2866527,2874593,2827995,2866525,2861657,2794336,2835994,2879955,2794335,2822791,2827993,2794334,2815252,2892973,2799919,2879954,2827994,2887800,2835866,2892971,2822655,2822654,2852979,2874590,2861655,2794331,2799925,2827997,2840563,2807569,2799927,2835998,2799926,2887801,2874596,2835997,2807567,2848329,2807568,2866528,2835996,2848328,2840564,2848332,2836000,2799928,2822792,2861661,2815254,2848331,43019074,43019493,43018572,43018742,43019771,43019492,43018685,43018891,2879959,2828014,2861678,2828011,2874732,2815387,2892984,2861676,2836011,2866541,2799942,2852996,2848472,2815386,2879972,2848471,2879970,2879971,2799943,2840574,2879974,2892986,2861677,2822807,2887951,2887952,2874734,2807715,2848476,2861679,2815390,2880107,2880108,2794361,2887953,2840579,2866548,2794362,2822811,2861685,2807719,2861686,2866547,2892991,2874738,2880109,2861684,2828017,2840577,2848477,2892989,2861687,2836021,2866549,2892994,2874739,2887955,2794363,2828022,2866550,2866551,2822814,2840580,43018405,43018407,43018744,43018406,2874741,2822815,2800073,2828023,2853003,2836019,2794358,2794357,2874737,2807717,2799949,2815392,2866546,2828019,2848478,2892990,2800069,2794359,2800070,2861683,36803359,36802961,36803230,36803102,36803180,36803200,36803196,36803286,2866553,2822816,2880112,2853008,42639327,42639614,42639176,42639348,42639411,42639537,42639371,42639273,42639493,42639221,2828027,2822820,2880118,2800079,2836024,2887961,2880119,2840587,2828151,43018409,2828152,2840586,2866684,1536242,2853013,43018687,2866683,2828150,2800078,1535374,2807721,2880116,2853011,2866559,2853012,2874745,2822819,2822818,2848480,43019888,2874744,2815399,2880117,1534087,2874743,43019494,2807722,2815398,2880115,1534990,1523712,1523525,1523542,1523709,1523616,1523924,1523499,1523681,1523876,2840591,2866687,2807725,2828158,43019463,2848486,2822825,2874750,1532774,2828157,43018893,2840590,2866686,2893002,1532354,2807724,2874748,2866685,2892997,2892998,2836026,2893000,2892999,2822823,43018989,2848482,2880123,2880122,1532427,2892996,43018688,2861824,2861823,2874747,1535404,2853155,2866698,2800087,2848499,2822963,2840597,2822964,2853154,2893141,2874758,2861835,2866699,2893143,2822965,2794529,2807736,2880131,2794528,2861836,2887971,2893145,2840719,2807738,2887972,2828170,2861838,2836165,2836166,1532909,1536316,1534638,1532961,1532931,1533871,1534994,1532512,1534771,1536567,1533895,1534643,1534941,1536127,1533161,1535324,43019190,43019596,43019080,43019343,43018991,43019595,43019497,43019773,2800090,2800091,2893147,2807741,2800092,2880133,2874761,2828171,2794531,2836167,2874760,2880132,2893146,2807739,2848501,2815413,2866702,2861840,2807742,2848503,2840720,2853158,2853159,2893148,1533553,1532627,2861845,2853165,2861846,2888102,2861841,2822969,2848636,2822968,2853162,2880136,2887975,2836170,2866704,2853161,2880135,2812932,2828173,2880138,2880139,2853164,2861843,2880137,2853163,2866705,1532656,1533695,1532597,1533972,1534492,1533050,1533592,1535278,1532670,1535614,1532272,1535713,1535442,1532491,1534022,1534469,2800093,2815415,2880134,2800094,2807883,2807886,2840738,2800238,2880293,2828188,2794550,2800108,2866850,2861863,2840737,2800109,2807885,2800240,2794552,2828190,2880294,2853184,2822990,2812953,2822989,2840742,2848660,2807889,2794556,2853322,2800243,2893166,2828322,2888124,2862001,2853321,2874905,2822996,2807890,2874904,2861999,2866854,2812955,2888120,2812954,2862003,2840744,2822998,2807891,2848663,2862002,2822997,2848664,2888126,2807892,2828324,2822999,43019863,43018582,43018413,43018749,2812960,2862005,2823000,2853325,2800241,2880296,2888121,2822994,2866855,2840740,2893164,2888122,2812956,2861994,2861995,2853185,2861996,2840741,2866856,2861997,2874908,2807899,2794563,2848669,2893169,2840748,2836194,2812967,2880302,2807900,2853327,2888128,2807894,2880298,2812962,2800247,2840746,2823136,2812963,2794560,2848665,2823135,2800245,2880300,2862006,2836191,2893168,2853329,2888129,2812964,2794717,2836195,2893170,2812969,2862011,2888132,2840749,2866861,2812968,2836196,2828328,2836192,2828329,2812966,2800248,2853336,2848675,2800253,2874914,2866867,2800254,2880310,2848803,2888138,2893177,2848801,2840757,2862013,2866868,2888136,2893175,2848676,2888135,2853337,2823144,2848671,2866862,2823138,2848672,2794718,2880303,2823139,2807902,2853331,2840751,2828342,2823147,2848804,2813096,2840888,2888140,2812972,2794722,2880311,2828341,2836329,2794723,2866871,2823148,2893180,43019897,43019192,43019501,43019777,43019500,2800256,2893314,2848806,2840891,2880313,1533897,1533669,2836199,2823140,2800251,2800250,2853332,1534275,1534536,1535242,2888133,2866864,2840753,2800252,2874913,2807903,2853334,2874911,2853335,2828332,2828335,2840754,2893174,2862012,2840755,2823149,2836331,2823150,2893319,2840893,2800257,2794729,2807910,2893321,2794727,2794728,2866874,2823153,2848809,2874924,2893322,2808041,2800258,2880318,2808042,2807911,2828346,2893323,2836333,2807912,2880316,2794731,2874926,2867016,2875080,2828497,2848832,2867017,2794748,1534433,1535173,1535270,1533989,2808070,2813128,2880472,2880473,2794752,2840919,2823308,2840920,2836363,2808068,2848834,2808069,2800739,2888289,2867020,2823307,2880470,2794751,2823171,2836361,2836362,2862168,2867019,2794750,2823311,2862171,2808071,2794906,2867021,2862170,2794756,2823312,2888290,2813129,2823310,2828499,2853499,2800741,2828498,2794754,2893343,2875083,2800744,2853500,2808072,2828502,2828503,2836364,43019089,43019472,43019599,43019866,43019473,43019090,43019899,43018584,43019779,43019865,43018994,43020091,2823314,2853502,2808074,2836366,43018417,43019254,2800745,2840921,2840922,43019194,43019502,2823315,36803328,36803057,1523552,1523570,1523761,1523692,1523671,1523730,1523677,1523704,1523784,1523878,1523526,1523663,1523622,1523632,1523690,1523407,1523505,1523345,1523382,1523861,1523611,1523474,1523529,1523467,1523908,1523716,1523406,1523800,1523689,1523862,1523336,1523758,1523788,2862020,2828351,2866879,2853346,2823157,2836339,2888271,2828353,2836338,2828352,2862025,2862026,2875060,2808051,2836344,2875061,2862027,2840902,2880459,2836343,2880452,2888272,2862021,2862022,2800266,2800265,2880454,2840899,2853347,2880453,2828361,2862032,2823163,2794740,2866884,2836356,2862165,2862164,2853354,2836355,2875070,2875071,2893338,2875072,2840911,2880466,2875073,2800276,2867010,2840910,2853356,2840908,2813123,2794742,2893337,2875069,2794743,2848825,2823165,2893336,2808057,2800273,2828492,2880464,2808058,2893334,2840907,2840906,2853355,2828491,2836345,2813115,2813117,2893330,2880461,2848819,2823159,2875063,2828355,2813116,2800277,2880467,2848829,2875077,2794745,2853357,2828493,2867013,2823167,2840914,2867011,2836358,2893340,2808063,2875074,2836359,2862167,2848827,2794744,2840912,2875078,2853359,2853360,2800736,2823169,2794746,2880468,2828494,2888286,2840915,43018897,43018755,43019193,43018898,43020090,43018992,43018756,43019470,43019778,43019085,2813124,2813125,2875079,2848831,2807564,2840430,2848324,2879950,2835865,2852860,2866521,2848323,2874586,2892968,2807563,2822652)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (43018731,43019585,43018671,43020075,43020074,43019484,43019483,43019485,43018730,43018395,43018566,43020070,43018668,43018875,43018876,43019760,43018669,43020071,2822632,2835848,2848302,2848303,2807547,2887780,43019988,43019764,43019765,43019069,43019884,43019488,43019883,43019586,2887781,2799784,2874573,2827859,2892843,2807549,43019177,2848299,2848300,2807546,2848301,2866382,2822631,43018565,2840424,2852842,2848297,2866380,2874571,2848298,43019882,2874577,2807552,2807553,2866389,2848304,2887784,2866384,2827860,2874575,2815237,2794168,2861505,2879802,2835849,2866386,2866385,2822636,2848306,2827862,2861509,2807551,2799786,2827861,2861506,2866383,2892844,2852844,2887783,2807554,2835852,2799788,2892845,2874576,2794169,2866387,2815240,2840428,2799910,2794171,2835854,2848312,2866394,2848313,2794327,2874581,2861516,2822641,2879937,2822640,2799911,2874580,2848311,2874579,2822637,2848307,2887787,2815242,2861519,2835857,2835856,2861517,2879939,2861518,2852850,2852851,2822643,2794328,2807560,43019071,43019180,43018882,43019588,2827864,2852852,2827865,2822644,2866391,2822638,2840426,2861512,2866392,2852846,2879808,2799909,2861513,2840427,2861514,2887788,2852847,2848310,2852848,2879934,42894769,42894768,40756812,44809812,45890318,40756792,4259143,4078442,4179713,2725382,2725383,2725378,2725380,2725379,2725381,2724750,2724751,2724746,2724748,2724747,2724749,2725320,2725321,2725316,2725318,2725317,2725319,2725258,2725259,2725254,2725256,2725255,2725257,2725095,2725093,2725094,2725053,2725051,2725052,2725199,2725866,2725863,2725869,2725747,2725746,2725816,2725815,2725810,2725809,2725822,2725821,2725637,2725670,2725667,2725673,40481952,2313916,2313915,44816449,4020231,40483085,4020092,44511471,44789913,44790436,4303988,43531516,4180615,44806571,44790480,4179979,4020091,4017884,44793474,43528002,43528004,43528003,43528001,43528000,4020525,40482273,4285725,2726519,2726534,2727186,2727264,1389578,1389711,42639428,2879798,2848174,2794165,2807542,2861501,2799781,43020068,42639194,1536538,2866378,2861500,2874570,2887775,2799780,2892838,43019449,1532893,2835846,2852839,2835847,2879795,2848170,2848169,2874568,2794164,2799779,43018982,2887773,2807541,2799777,2861497,2815230,2874563,2807538,2840416,2848163,2887769,2827849,43018392,2887768,2840415,2807539,2827853,2887772,2815232,2822627,2794162,2866376,2861499,2815233,43018666,2840421,2799778,2827852,2887771,2866375,2848165,2840419,2840418,2840420,2848166,2879793,43019881,2887770,2840417,43018567,43019987,43018397,2866531,2887802,2848334,2794337,2848333,2799929,2879960,2848326,2827991,2799918,2799917,2852980,2807565,2892972,2822787,1534820,1536188,1535946,1534129,1535200,1535255,1535812,1536499,2887798,2827992,2835993,2887799,2866522,2822789,2879953,2852981,2799932,2794338,2861665,2861664,2827999,2879961,2861663,2887803,2828000,2852984,2815255,2861667,2799935,2822796,2852989,2848337,2852986,2815374,2892976,2799933,2852987,2861668,2861669,2836003,2807703,2887934,2874724,2807704,2815376,2892978,2848336,2799934,2822794,2794341,2828003,2879964,2887804,2828001,2836001,2887805,2815377,2848464,2836008,2874726,2866533,2836006,2822795,2836005,2887937,2874728,2879966,2815382,2892982,2887940,2861675,2794349,2866537,2828009,2887939,2879967,2852993,2807709,2822801,2874729,2799936,2861671,2799938,2799937,2840570,2887945,2866538,2852994,2887942,2848469,2840569,2879968,2852995,2836010,2822803,2866539,43019337,43019894,43018686,43018404,2807711,2848470,2815383,2866540,2848466,2807706,2848467,2794345,2861674,2866536,2874727,2815380,2840567,2840568,2836009,2794346,2822799,2828007,2815381,2852991,2853001,2861680,2874733,2866545,2848474,2840575,2828013,2866542,2836014,2794354,2794355,2866543,2815389,2880103,2822805,2807714,2799948,2794356,2866544,2828015,2880104,2799946,1523326,1523772,1523672,1523607,1523445,1523545,1523751,1523904,1523488,1523686,1523764,1523847,1523353,1523333,1523609,2874742,2861691,2794368,2887959,2880114,2840583,2800074,2828025,2866557,43019076,2836022,2866556,2866555,1532475,2892995,43019338,2866554,2794367,2794366,1533307,2874746,2794521,2840589,1532081,2822822,2822821,1535215,2815400,2815405,2822827,2822826,2853019,2848488,2861827,2836029,2887963,2800081,2828160,1532685,2848487,2800080,1534470,2836160,2822959,2861831,2880127,2848491,2866691,1532056,2874754,2887966,2836161,2853146,1536337,2836031,2874753,2887965,2853145,2861828,2836033,1536173,2794522,2822958,2836032,2828163,1533395,2880125,2815406,2853021,2880126,2848490,2807727,1533279,2840592,2887964,2853020,2807726,1533741,2822961,2866694,2794524,2853149,2794523,2836163,1532312,2840594,2880128,2828165,2887968,1533052,2815407,2866693,2822960,2874755,2807730,2853147,1532241,2861833,2840593,2828164,2848492,1535914,2848494,2840595,2807733,2828166,2794526,2848496,1532826,2893009,2887969,2848495,2794525,1534622,43018410,43019593,43018894,43018895,43018747,43019496,43019078,43019341,43019340,43019495,2893140,2828167,2828168,2815410,2880130,2822962,1533963,2853152,2848497,2866697,2815409,1533841,36803410,2828156,2822824,2815403,2848485,2815404,2893151,2880141,2874892,2836172,2880140,2866707,2840723,2840722,2807875,2822974,2866711,2853169,2861853,2874897,2828179,2853170,2794537,2888106,2848640,2800097,2836175,2866712,2880280,2861851,2807872,2866708,2836173,2888103,2848641,2822976,2866714,2893153,2807878,2880282,2836176,2853171,2822977,2848643,2880283,2848642,43018577,43019775,43020087,43018578,2836178,2800099,2840728,2893154,2866709,2822972,2853166,2874894,2866710,2861848,2893152,2828174,2880142,2794535,2874896,2836174,2828175,2880277,2853168,2848639,2893157,2812942,2861857,2828183,2853176,2794541,2866847,2840733,2800104,1536274,2874902,2812943,2828182,2848648,2822982,2836183,2866722,1532747,2861856,2866721,2893156,2853175,2800101,2822979,2822980,2836180,2880285,2874900,2840729,43019597,2836179,2848645,2794539,1535760,2866719,2807881,2800103,2822978,2880284,2888108,43019465,2807880,2828181,2866718,1532449,2800102,2866717,2866716,36803242,36802966,2794551,2836188,2822992,2893162,2822985,2880290,2880291,2812949,2888116,2861862,2848655,2853183,2794547,2861861,2836184,2888115,2828187,2848656,2800107,2800106,2888117,2866849,2822987,2794548,2840734,2853179,2853180,2861859,2848650,2848652,2888110,2848651,2880288,2866848,2893160,2880289,2828185,2861858,2888111,2893158,2840735,2848653,2874903,36802938,36803387,36803284,36802999,36803204,36803073,1536392,1533689,2813132,2862175,2841053,2848959,2853508,1535377,1535699,1533333,2893344,2823316,2794916,2875088,2848961,2853511,2836499,2848962,2823324,2893352,2875090,1532612,2848963,2823323,2875089,2813269,2800754,2867028,2794917,1533822,2862181,2867029,2794908,2880477,2800747,2841052,2823318,2853505,2794910,2867025,2848838,43019900,2875085,2823317,2880479,1532027,2800748,2828506,2853504,2867024,2893345,2813131,43018418,2880478,2867023,2853503,1533324,2862174,2808076,2794909,1532097,1532121,2880482,2794911,2841054,2828509,2880483,1532122,1534326,1534284,1536093,1533826,2794912,2794913,2813134,2893350,2813133,1534964,1533016,1536082,36803026,36803369,1533839,1534684,2794914,2836496,2813267,2880485,2823322,1534915,1536550,1535529,2853510,2862178,2848818,2813114,2794736,2875059,2888273,2808050,2840900,2880457,2862023,2808049,2836334,2862016,2813106,2874929,2813108,2853341,2813107,2874928,2813105,2880448,2880450,2848812,2813112,2840897,2813113,2893327,2808045,2848813,2880451,2840896,2893324,2836335,2848810,2862018,2853342,2794733,2848811,2808044,2866875,2874930,2848814,2800261,2823156,2866878,2888270,2862019,2840898,2794734,2828349,2874931,1523620,1523608,1523601,1523448,1523864,1523563,1523835,2880469,2853496,2813126,2836360,2808065,2823170,2853350,2808052,2848820,2813119,2888278,2800268,2893332,2888277,2893331,2888276,2836350,2853351,2862030,2862031,2828357,2853352,2836352,2836351,2808054,2800270,2848821,2840903,2794738,2836348,2840904,2828356,2848823,2848822,2808053,2888279,2828358,2828359,2828360,2836353,2823162,2866883,2823161,2800272,2808055,2823160,43014802,43014822,43014812,42537597,43531439,44806668,2001504,37157744,4337739,4337738,4336469,43531438,4337740,37206820,43531515,4080289,4264286,4337741,43533352,43533247,4178169,45769228,40487945,4177366,44790409,4322906,44511138,44784573,43533248,43533353,2313795,4018703,37153597,37157437,43531440,4229994,2001523,2001501,2001500,2617370,2617369,1389580,44806005,40756772,40756774,2001549,4051039,2727297,4137127,2720628,2617584,40756784,40756789,4208483,4323638,44511139,44511223,44511051,44511275,44511457,44789848,40484106,4338620,4338183,4339980,4336606,4339716,4337196,4336902,4339967,4174690,4195096,4337289,4017882,44511466,4010256,4271860,4306306,4043696,2001435,4171677,4020382,4337198,4287403,4120152,4336743,4054814,44511026,44511468,4146733,4186747,2001473,2107178,2107027,1552633,1389579,1389577,4089017,4276350,4339949,4337308,44805463,36684977,4201063,2726162,43019073,43019459,43019893,43018571,2887795,43018741,43018889,2852859,2835863,2848321,43020083,43018740,43019187,43018402,2835864,43019886,43019458,2815247,2822647,2852853,2852854,2879941,43019182,43018401,43018734,43020080,2807562,43019995,43019183,2887792,2815243,2807561,43020079,43018884,43019181,43019994,2799912,43018400,43019454,2815244,2848320,2827988,2879946,2861654,43019891,43020082,43019491,43018987,2887794,43019770,43019456,2827989,2852856,2835862,43019769,43018986,43019590,43018683,2852857,43019335,43018682,2874583,2799914,2861521,2822650,2835861,43018737,43018569,43019185,43018888,2822651,43019589,43018887,2879944,2815245,2822649,43018886,43019767,43019184,43020081,2827866,43019455,43019885,2827986,2879951,2879952,2815249,2887796,2892970,2892969,2840433,2815248,2815253,2874594,2861658,2827996,2835995,2840560,2866527,2874593,2827995,2866525,2861657,2794336,2835994,2879955,2794335,2822791,2827993,2794334,2815252,2892973,2799919,2879954,2827994,2887800,2835866,2892971,2822655,2822654,2852979,2874590,2861655,2794331,2799925,2827997,2840563,2807569,2799927,2835998,2799926,2887801,2874596,2835997,2807567,2848329,2807568,2866528,2835996,2848328,2840564,2848332,2836000,2799928,2822792,2861661,2815254,2848331,43019074,43019493,43018572,43018742,43019771,43019492,43018685,43018891,2879959,2828014,2861678,2828011,2874732,2815387,2892984,2861676,2836011,2866541,2799942,2852996,2848472,2815386,2879972,2848471,2879970,2879971,2799943,2840574,2879974,2892986,2861677,2822807,2887951,2887952,2874734,2807715,2848476,2861679,2815390,2880107,2880108,2794361,2887953,2840579,2866548,2794362,2822811,2861685,2807719,2861686,2866547,2892991,2874738,2880109,2861684,2828017,2840577,2848477,2892989,2861687,2836021,2866549,2892994,2874739,2887955,2794363,2828022,2866550,2866551,2822814,2840580,43018405,43018407,43018744,43018406,2874741,2822815,2800073,2828023,2853003,2836019,2794358,2794357,2874737,2807717,2799949,2815392,2866546,2828019,2848478,2892990,2800069,2794359,2800070,2861683,36803359,36802961,36803230,36803102,36803180,36803200,36803196,36803286,2866553,2822816,2880112,2853008,42639327,42639614,42639176,42639348,42639411,42639537,42639371,42639273,42639493,42639221,2828027,2822820,2880118,2800079,2836024,2887961,2880119,2840587,2828151,43018409,2828152,2840586,2866684,1536242,2853013,43018687,2866683,2828150,2800078,1535374,2807721,2880116,2853011,2866559,2853012,2874745,2822819,2822818,2848480,43019888,2874744,2815399,2880117,1534087,2874743,43019494,2807722,2815398,2880115,1534990,1523712,1523525,1523542,1523709,1523616,1523924,1523499,1523681,1523876,2840591,2866687,2807725,2828158,43019463,2848486,2822825,2874750,1532774,2828157,43018893,2840590,2866686,2893002,1532354,2807724,2874748,2866685,2892997,2892998,2836026,2893000,2892999,2822823,43018989,2848482,2880123,2880122,1532427,2892996,43018688,2861824,2861823,2874747,1535404,2853155,2866698,2800087,2848499,2822963,2840597,2822964,2853154,2893141,2874758,2861835,2866699,2893143,2822965,2794529,2807736,2880131,2794528,2861836,2887971,2893145,2840719,2807738,2887972,2828170,2861838,2836165,2836166,1532909,1536316,1534638,1532961,1532931,1533871,1534994,1532512,1534771,1536567,1533895,1534643,1534941,1536127,1533161,1535324,43019190,43019596,43019080,43019343,43018991,43019595,43019497,43019773,2800090,2800091,2893147,2807741,2800092,2880133,2874761,2828171,2794531,2836167,2874760,2880132,2893146,2807739,2848501,2815413,2866702,2861840,2807742,2848503,2840720,2853158,2853159,2893148,1533553,1532627,2861845,2853165,2861846,2888102,2861841,2822969,2848636,2822968,2853162,2880136,2887975,2836170,2866704,2853161,2880135,2812932,2828173,2880138,2880139,2853164,2861843,2880137,2853163,2866705,1532656,1533695,1532597,1533972,1534492,1533050,1533592,1535278,1532670,1535614,1532272,1535713,1535442,1532491,1534022,1534469,2800093,2815415,2880134,2800094,2807883,2807886,2840738,2800238,2880293,2828188,2794550,2800108,2866850,2861863,2840737,2800109,2807885,2800240,2794552,2828190,2880294,2853184,2822990,2812953,2822989,2840742,2848660,2807889,2794556,2853322,2800243,2893166,2828322,2888124,2862001,2853321,2874905,2822996,2807890,2874904,2861999,2866854,2812955,2888120,2812954,2862003,2840744,2822998,2807891,2848663,2862002,2822997,2848664,2888126,2807892,2828324,2822999,43019863,43018582,43018413,43018749,2812960,2862005,2823000,2853325,2800241,2880296,2888121,2822994,2866855,2840740,2893164,2888122,2812956,2861994,2861995,2853185,2861996,2840741,2866856,2861997,2874908,2807899,2794563,2848669,2893169,2840748,2836194,2812967,2880302,2807900,2853327,2888128,2807894,2880298,2812962,2800247,2840746,2823136,2812963,2794560,2848665,2823135,2800245,2880300,2862006,2836191,2893168,2853329,2888129,2812964,2794717,2836195,2893170,2812969,2862011,2888132,2840749,2866861,2812968,2836196,2828328,2836192,2828329,2812966,2800248,2853336,2848675,2800253,2874914,2866867,2800254,2880310,2848803,2888138,2893177,2848801,2840757,2862013,2866868,2888136,2893175,2848676,2888135,2853337,2823144,2848671,2866862,2823138,2848672,2794718,2880303,2823139,2807902,2853331,2840751,2828342,2823147,2848804,2813096,2840888,2888140,2812972,2794722,2880311,2828341,2836329,2794723,2866871,2823148,2893180,43019897,43019192,43019501,43019777,43019500,2800256,2893314,2848806,2840891,2880313,1533897,1533669,2836199,2823140,2800251,2800250,2853332,1534275,1534536,1535242,2888133,2866864,2840753,2800252,2874913,2807903,2853334,2874911,2853335,2828332,2828335,2840754,2893174,2862012,2840755,2823149,2836331,2823150,2893319,2840893,2800257,2794729,2807910,2893321,2794727,2794728,2866874,2823153,2848809,2874924,2893322,2808041,2800258,2880318,2808042,2807911,2828346,2893323,2836333,2807912,2880316,2794731,2874926,2867016,2875080,2828497,2848832,2867017,2794748,1534433,1535173,1535270,1533989,2808070,2813128,2880472,2880473,2794752,2840919,2823308,2840920,2836363,2808068,2848834,2808069,2800739,2888289,2867020,2823307,2880470,2794751,2823171,2836361,2836362,2862168,2867019,2794750,2823311,2862171,2808071,2794906,2867021,2862170,2794756,2823312,2888290,2813129,2823310,2828499,2853499,2800741,2828498,2794754,2893343,2875083,2800744,2853500,2808072,2828502,2828503,2836364,43019089,43019472,43019599,43019866,43019473,43019090,43019899,43018584,43019779,43019865,43018994,43020091,2823314,2853502,2808074,2836366,43018417,43019254,2800745,2840921,2840922,43019194,43019502,2823315,36803328,36803057,1523552,1523570,1523761,1523692,1523671,1523730,1523677,1523704,1523784,1523878,1523526,1523663,1523622,1523632,1523690,1523407,1523505,1523345,1523382,1523861,1523611,1523474,1523529,1523467,1523908,1523716,1523406,1523800,1523689,1523862,1523336,1523758,1523788,2862020,2828351,2866879,2853346,2823157,2836339,2888271,2828353,2836338,2828352,2862025,2862026,2875060,2808051,2836344,2875061,2862027,2840902,2880459,2836343,2880452,2888272,2862021,2862022,2800266,2800265,2880454,2840899,2853347,2880453,2828361,2862032,2823163,2794740,2866884,2836356,2862165,2862164,2853354,2836355,2875070,2875071,2893338,2875072,2840911,2880466,2875073,2800276,2867010,2840910,2853356,2840908,2813123,2794742,2893337,2875069,2794743,2848825,2823165,2893336,2808057,2800273,2828492,2880464,2808058,2893334,2840907,2840906,2853355,2828491,2836345,2813115,2813117,2893330,2880461,2848819,2823159,2875063,2828355,2813116,2800277,2880467,2848829,2875077,2794745,2853357,2828493,2867013,2823167,2840914,2867011,2836358,2893340,2808063,2875074,2836359,2862167,2848827,2794744,2840912,2875078,2853359,2853360,2800736,2823169,2794746,2880468,2828494,2888286,2840915,43018897,43018755,43019193,43018898,43020090,43018992,43018756,43019470,43019778,43019085,2813124,2813125,2875079,2848831,2807564,2840430,2848324,2879950,2835865,2852860,2866521,2848323,2874586,2892968,2807563,2822652)
  and c.invalid_reason is null

) E ON I.concept_id = E.concept_id
WHERE E.concept_id is null
) C UNION ALL 
SELECT 3 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (9201)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (9201)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 4 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (262,9203)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (262,9203)
  and c.invalid_reason is null

) I
) C;

UPDATE STATISTICS #Codesets;


SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Procedure Occurrence Criteria
select C.person_id, C.procedure_occurrence_id as event_id, C.start_date, C.end_date,
       C.visit_occurrence_id, C.start_date as sort_date
from 
(
  select po.person_id,po.procedure_occurrence_id,po.procedure_concept_id,po.visit_occurrence_id,po.quantity,po.procedure_date as start_date, DATEADD(day,1,po.procedure_date) as end_date 
  FROM @cdm_database_schema.PROCEDURE_OCCURRENCE po
JOIN #Codesets cs on (po.procedure_concept_id = cs.concept_id and cs.codeset_id = 2)
) C


-- End Procedure Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,365,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

select 0 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_0
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Demographic Criteria
SELECT 0 as index_id, e.person_id, e.event_id
FROM #qualified_events E
JOIN @cdm_database_schema.PERSON P ON P.PERSON_ID = E.PERSON_ID
WHERE YEAR(E.start_date) - P.year_of_birth >= 18
GROUP BY e.person_id, e.event_id
-- End Demographic Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 1 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_1
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.start_date, C.end_date,
  C.visit_occurrence_id, C.start_date as sort_date
FROM 
(
  SELECT co.person_id,co.condition_occurrence_id,co.condition_concept_id,co.visit_occurrence_id,co.condition_start_date as start_date, COALESCE(co.condition_end_date, DATEADD(day,1,co.condition_start_date)) as end_date 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 1)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,1,P.START_DATE) AND A.START_DATE <= DATEADD(day,14,P.START_DATE) ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 2 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_2
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.start_date, C.end_date,
  C.visit_occurrence_id, C.start_date as sort_date
FROM 
(
  SELECT co.person_id,co.condition_occurrence_id,co.condition_concept_id,co.visit_occurrence_id,co.condition_start_date as start_date, COALESCE(co.condition_end_date, DATEADD(day,1,co.condition_start_date)) as end_date 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 1)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE <= DATEADD(day,-1,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 3 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_3
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.start_date, C.end_date,
       C.visit_occurrence_id, C.start_date as sort_date
from 
(
  select vo.person_id,vo.visit_occurrence_id,vo.visit_concept_id,vo.visit_start_date as start_date, vo.visit_end_date as end_date 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo
JOIN #Codesets cs on (vo.visit_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Visit Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,-1,P.START_DATE) AND A.START_DATE <= DATEADD(day,0,P.START_DATE) AND A.END_DATE >= DATEADD(day,1,P.START_DATE) AND A.END_DATE <= P.OP_END_DATE ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

SELECT inclusion_rule_id, person_id, event_id
INTO #inclusion_events
FROM (select inclusion_rule_id, person_id, event_id from #Inclusion_0
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_1
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_2
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_3) I;
TRUNCATE TABLE #Inclusion_0;
DROP TABLE #Inclusion_0;

TRUNCATE TABLE #Inclusion_1;
DROP TABLE #Inclusion_1;

TRUNCATE TABLE #Inclusion_2;
DROP TABLE #Inclusion_2;

TRUNCATE TABLE #Inclusion_3;
DROP TABLE #Inclusion_3;


select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

  -- the matching group with all bits set ( POWER(2,# of inclusion rules) - 1 = inclusion_rule_mask
  WHERE (MG.inclusion_rule_mask = POWER(cast(2 as bigint),4)-1)

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,60,start_date) > op_end_date then op_end_date else DATEADD(day,60,start_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 0, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , SUM(event_type) OVER (PARTITION BY person_id ORDER BY event_date, event_type ROWS UNBOUNDED PRECEDING) AS interval_status
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,0,end_date) as end_date
          , 1 AS event_type
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE interval_status = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



-- Create a temp table of inclusion rule rows for joining in the inclusion rule impact analysis

select cast(rule_sequence as int) as rule_sequence
into #inclusion_rules
from (
  SELECT CAST(0 as int) as rule_sequence UNION ALL SELECT CAST(1 as int) as rule_sequence UNION ALL SELECT CAST(2 as int) as rule_sequence UNION ALL SELECT CAST(3 as int) as rule_sequence
) IR;


-- Find the event that is the 'best match' per person.  
-- the 'best match' is defined as the event that satisfies the most inclusion rules.
-- ties are solved by choosing the event that matches the earliest inclusion rule, and then earliest.

select q.person_id, q.event_id
into #best_events
from #qualified_events Q
join (
	SELECT R.person_id, R.event_id, ROW_NUMBER() OVER (PARTITION BY R.person_id ORDER BY R.rule_count DESC,R.min_rule_id ASC, R.start_date ASC) AS rank_value
	FROM (
		SELECT Q.person_id, Q.event_id, COALESCE(COUNT(DISTINCT I.inclusion_rule_id), 0) AS rule_count, COALESCE(MIN(I.inclusion_rule_id), 0) AS min_rule_id, Q.start_date
		FROM #qualified_events Q
		LEFT JOIN #inclusion_events I ON q.person_id = i.person_id AND q.event_id = i.event_id
		GROUP BY Q.person_id, Q.event_id, Q.start_date
	) R
) ranked on Q.person_id = ranked.person_id and Q.event_id = ranked.event_id
WHERE ranked.rank_value = 1
;

-- modes of generation: (the same tables store the results for the different modes, identified by the mode_id column)
-- 0: all events
-- 1: best event


-- BEGIN: Inclusion Impact Analysis - event
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 0 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #qualified_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 0 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #qualified_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #qualified_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 0 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 0 as mode_id
FROM
(select count_big(event_id) as total from #qualified_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 0 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - event

-- BEGIN: Inclusion Impact Analysis - person
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 1 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #best_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 1 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #best_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #best_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 1 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 1 as mode_id
FROM
(select count_big(event_id) as total from #best_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 1 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - person

TRUNCATE TABLE #best_events;
DROP TABLE #best_events;

TRUNCATE TABLE #inclusion_rules;
DROP TABLE #inclusion_rules;


TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;
